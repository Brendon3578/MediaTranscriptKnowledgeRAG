# üìÑ PRD ‚Äî Sistema de Transcri√ß√£o, Indexa√ß√£o Sem√¢ntica e Busca (RAG)

## 1. Vis√£o Geral

O sistema tem como objetivo permitir o upload de arquivos de m√≠dia (√°udio/v√≠deo), realizar a transcri√ß√£o autom√°tica do conte√∫do, gerar embeddings vetoriais por segmento e disponibilizar uma API de consulta sem√¢ntica baseada em similaridade vetorial (RAG).

A arquitetura √© orientada a servi√ßos independentes, comunicando-se de forma ass√≠ncrona via eventos (RabbitMQ), com persist√™ncia em PostgreSQL + pgvector e uso de IA local (Whisper + Ollama).

## 2. Objetivos do Produto

### Objetivo Principal

Permitir que usu√°rios fa√ßam buscas sem√¢nticas em conte√∫dos de m√≠dia transcritos, retornando trechos relevantes com contexto temporal.

### Objetivos Secund√°rios

- Desacoplar upload, transcri√ß√£o, embeddings e consulta
- Suportar processamento ass√≠ncrono e escal√°vel
- Manter todo o processamento on-premise / local
- Preparar base s√≥lida para futuras extens√µes (resumo, insights, RAG avan√ßado)

## 3. Escopo Atual (O que o sistema FAZ)

### ‚úÖ Em escopo

- Upload de arquivos de m√≠dia
- Persist√™ncia dos metadados da m√≠dia
- Publica√ß√£o de eventos de upload
- Transcri√ß√£o autom√°tica usando Whisper (segmentada por tempo)
- Sele√ß√£o din√¢mica de modelo Whisper (Medium, Large, etc.)
- Persist√™ncia da transcri√ß√£o, m√©tricas e dos segmentos
- Gera√ß√£o de embeddings por segmento
- Persist√™ncia vetorial usando pgvector
- Busca sem√¢ntica por similaridade
- Gera√ß√£o de respostas via LLM com base nos trechos recuperados

### ‚ùå Fora de escopo (por enquanto)

- Resumo autom√°tico
- An√°lise de sentimento
- Extra√ß√£o de insights
- Interface gr√°fica
- Autentica√ß√£o/autoriza√ß√£o
- Versionamento de embeddings
- Multi-tenant

## 4. Arquitetura Geral

### Estilo

- Arquitetura orientada a eventos
- Processamento ass√≠ncrono
- Separa√ß√£o clara de responsabilidades
- IA local (sem depend√™ncia de APIs externas)

### Componentes Principais

| Servi√ßo | Responsabilidade |
| :--- | :--- |
| **Upload.Api** | Receber arquivos e publicar eventos |
| **Transcription.Worker** | Transcrever m√≠dia em texto segmentado |
| **Embedding.Worker** | Gerar embeddings por segmento |
| **Query.Api** | Executar buscas sem√¢nticas e RAG |
| **Shared** | Contratos e eventos compartilhados |

## 5. Fluxo Principal do Sistema

### 5.1 Upload

1. Usu√°rio envia arquivo para **Upload.Api** (opcionalmente escolhendo o modelo Whisper)
2. Arquivo √© salvo localmente
3. Metadados s√£o persistidos no banco
4. Evento `MediaUploadedEvent` √© publicado no RabbitMQ

### 5.2 Transcri√ß√£o

1. **Transcription.Worker** consome `MediaUploadedEvent`
2. √Åudio √© extra√≠do/convertido
3. Whisper realiza a transcri√ß√£o (usando modelo solicitado ou default)
4. Texto √© segmentado com timestamps
5. Transcri√ß√£o, m√©tricas (tempo, modelo) e segmentos s√£o salvos no banco
6. Evento `MediaTranscribedEvent` √© publicado

### 5.3 Gera√ß√£o de Embeddings

1. **Embedding.Worker** consome `MediaTranscribedEvent`
2. Segmentos ainda n√£o processados s√£o carregados
3. Embeddings s√£o gerados via Ollama
4. Vetores s√£o persistidos no PostgreSQL (pgvector)
5. Processo √© idempotente por (segmento + modelo)

### 5.4 Consulta Sem√¢ntica (RAG)

1. Usu√°rio envia pergunta para **Query.Api**
2. Pergunta √© convertida em embedding
3. Consulta vetorial √© executada ( `<=>` )
4. Segmentos mais pr√≥ximos s√£o retornados
5. Contexto √© montado com timestamps
6. LLM gera resposta baseada no contexto

## 6. Modelo de Dados (Alto n√≠vel)

### media

- `id` (UUID)
- `file_name` (VARCHAR)
- `file_path` (VARCHAR)
- `content_type` (VARCHAR)
- `status` (INTEGER)
- `file_size_bytes` (BIGINT)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

### transcriptions

- `id` (UUID)
- `media_id` (UUID)
- `text` (TEXT)
- `language` (TEXT)
- `model_name` (TEXT)
- `processing_time_seconds` (REAL)
- `created_at` (TIMESTAMP)

### transcription_segments

- `id` (UUID)
- `transcription_id` (UUID)
- `media_id` (UUID)
- `segment_index` (INT)
- `text` (TEXT)
- `start_seconds` (REAL)
- `end_seconds` (REAL)
- `confidence` (REAL)
- `created_at` (TIMESTAMP)

### embeddings

- `id` (UUID)
- `media_id` (UUID)
- `transcription_id` (UUID)
- `transcription_segment_id` (UUID)
- `model_name` (TEXT)
- `chunk_text` (TEXT)
- `embedding` (VECTOR)
- `created_at` (TIMESTAMP)

## 7. Tecnologias Utilizadas

### Backend

- .NET 10
- ASP.NET Web API
- Background Workers

### IA

- Whisper.NET (transcri√ß√£o)
- Ollama (embeddings e chat)
- Microsoft.Extensions.AI

### Infraestrutura

- RabbitMQ
- PostgreSQL
- pgvector
- Docker

### Acesso a dados

- Entity Framework Core (escrita)
- SQL + Npgsql (consulta vetorial)

## 8. Requisitos N√£o Funcionais

- Processamento ass√≠ncrono
- Idempot√™ncia na gera√ß√£o de embeddings
- Toler√¢ncia a falhas em workers
- Observabilidade via logs
- Baixo acoplamento entre servi√ßos
- C√≥digo leg√≠vel e manuten√≠vel

## 9. Premissas e Restri√ß√µes

### Premissas

- Modelos de IA rodam localmente
- Banco √∫nico compartilhado
- RabbitMQ √© o backbone de eventos

### Restri√ß√µes

- Sem UI
- Sem orquestra√ß√£o complexa
- Sem versionamento de modelos

## 10. Estado Atual do Produto

‚úÖ **Produto funcional**
